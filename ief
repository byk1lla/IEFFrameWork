#!/usr/bin/env php
<?php

// CLI Entry Point
define('ROOT_PATH', __DIR__);
define('APP_PATH', ROOT_PATH . '/app');
define('CONFIG_PATH', ROOT_PATH . '/config');
define('STORAGE_PATH', ROOT_PATH . '/storage');

if (file_exists(ROOT_PATH . '/vendor/autoload.php')) {
    require_once ROOT_PATH . '/vendor/autoload.php';
} else {
    echo "Error: Vendor directory not found. Please run 'composer install'.\n";
    exit(1);
}

use App\Core\Database;

// Basic CLI Router
$args = array_slice($argv, 1);
$command = $args[0] ?? 'help';

echo "\nðŸ¦… IEF Framework CLI Tool\n";
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

switch ($command) {
    case 'serve':
        $port = $args[1] ?? 8000;
        echo "Updating development server at http://localhost:$port...\n";
        passthru("php -S localhost:$port");
        break;

    case 'make:controller':
        $name = $args[1] ?? null;
        if (!$name) {
            echo "Usage: ./ief make:controller <Name>\n";
            exit(1);
        }
        // Sanitize name: remove .php if user typed it
        $name = str_replace('.php', '', $name);
        $name = ucfirst($name);
        if (!str_ends_with($name, 'Controller')) {
            $name .= 'Controller';
        }
        
        $path = APP_PATH . "/Controllers/{$name}.php";
        if (file_exists($path)) {
            echo "Error: Controller {$name} already exists.\n";
            exit(1);
        }

        $template = "<?php\n\nnamespace App\Controllers;\n\nuse App\Core\Controller;\n\nclass {$name} extends Controller\n{\n    public function index()\n    {\n        // returning view\n    }\n}\n";
        
        file_put_contents($path, $template);
        echo "Controller created: {$path}\n";
        break;

    case 'make:model':
        $name = $args[1] ?? null;
        if (!$name) {
            echo "Usage: ./ief make:model <Name>\n";
            exit(1);
        }
        $name = str_replace('.php', '', $name);
        $name = ucfirst($name);
        
        $path = APP_PATH . "/Models/{$name}.php";
        if (file_exists($path)) {
            echo "Error: Model {$name} already exists.\n";
            exit(1);
        }

        $table = strtolower($name) . 's'; // simple pluralization
        $template = "<?php\n\nnamespace App\Models;\n\nuse App\Core\Model;\n\nclass {$name} extends Model\n{\n    protected static string \$table = '{$table}';\n    protected static array \$fillable = [];\n}\n";
        
        file_put_contents($path, $template);
        echo "Model created: {$path}\n";
        break;
        
    case 'migrate':
        echo "Starting migration...\n";
        try {
            $db = Database::getInstance();
            
            // Create migrations table if not exists
            $db->execute("CREATE TABLE IF NOT EXISTS migrations (
                id INT AUTO_INCREMENT PRIMARY KEY,
                migration VARCHAR(255),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )");

            // Get applied migrations
            $appliedMigrations = $db->fetchAll("SELECT migration FROM migrations");
            $applied = array_map(fn($m) => $m['migration'], $appliedMigrations);

            // Get all migration files
            $files = glob(APP_PATH . '/Database/Migrations/*.php');
            $newMigrations = [];

            foreach ($files as $file) {
                $migration = basename($file, '.php');
                if (!in_array($migration, $applied)) {
                    $newMigrations[] = $file;
                }
            }

            if (empty($newMigrations)) {
                echo "Nothing to migrate.\n";
            } else {
                foreach ($newMigrations as $file) {
                    $migration = basename($file, '.php');
                    echo "Migrating: $migration\n";
                    
                    require_once $file;
                    $className = 'App\\Database\\Migrations\\' . $migration;
                    $instance = new $className();
                    
                    $instance->up($db);
                    
                    $db->execute("INSERT INTO migrations (migration) VALUES (?)", [$migration]);
                    echo "Migrated:  $migration\n";
                }
                echo "Migration completed successfully.\n";
            }

        } catch (Exception $e) {
            echo "Migration failed: " . $e->getMessage() . "\n";
            exit(1);
        }
        break;
        
    case 'help':
    default:
        echo "Available commands:\n";
        echo "  serve [port]           Start PHP development server\n";
        echo "  make:controller <name> Create a new controller\n";
        echo "  make:model <name>      Create a new model\n";
        echo "  migrate                Run database migrations\n";
        echo "  help                   Show this help message\n";
        break;
}

echo "\n";
